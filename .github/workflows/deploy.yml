name: Deploy to Cloudflare Workers

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '25'

      - name: Setup pnpm
        run: npm install -g pnpm

      - name: Install dependencies
        run: pnpm install

      - name: Build
        run: pnpm build

      - name: Create .assetsignore
        run: echo "_worker.js" > dist/.assetsignore

      - name: Get Cloudflare Account ID
        id: cf_account
        run: |
          ACCOUNT_ID=$(npx wrangler whoami 2>&1 | grep -oP '(?<=\| )[a-f0-9]{32}(?= \|)' | head -1)
          echo "account_id=$ACCOUNT_ID" >> $GITHUB_OUTPUT
        env:
          CLOUDFLARE_API_KEY: ${{ secrets.CLOUDFLARE_API_KEY }}
          CLOUDFLARE_EMAIL: ${{ secrets.CLOUDFLARE_EMAIL }}

      - name: Deploy to Cloudflare Workers
        run: npx wrangler deploy --name "${{ vars.SITE_SUBDOMAIN }}-xiyo-dev"
        env:
          CLOUDFLARE_API_KEY: ${{ secrets.CLOUDFLARE_API_KEY }}
          CLOUDFLARE_EMAIL: ${{ secrets.CLOUDFLARE_EMAIL }}
          CLOUDFLARE_ACCOUNT_ID: ${{ steps.cf_account.outputs.account_id }}

      - name: Configure custom domain
        run: |
          SUBDOMAIN="${{ vars.SITE_SUBDOMAIN }}"
          WORKER_NAME="${SUBDOMAIN}-xiyo-dev"
          HOSTNAME="${SUBDOMAIN}.xiyo.dev"
          ACCOUNT_ID="${{ steps.cf_account.outputs.account_id }}"

          echo "Setting up custom domain: $HOSTNAME -> $WORKER_NAME"

          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "https://api.cloudflare.com/client/v4/accounts/${ACCOUNT_ID}/workers/domains" \
            -H "X-Auth-Email: ${{ secrets.CLOUDFLARE_EMAIL }}" \
            -H "X-Auth-Key: ${{ secrets.CLOUDFLARE_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"hostname\": \"${HOSTNAME}\",
              \"service\": \"${WORKER_NAME}\",
              \"environment\": \"production\"
            }")

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "409" ]; then
            echo "Custom domain configured successfully (or already exists)"
          else
            echo "Warning: Custom domain setup returned $HTTP_CODE"
            echo "$BODY"
          fi
